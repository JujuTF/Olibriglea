<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backoffice - Gest√£o de Pontos</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Lora:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/responsive.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/includes.js"></script>
</head>
<body>
       <div data-include="components/header.html"></div>

    <div class="container">
        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon blue">üçΩÔ∏è</div>
                <div class="stat-info">
                    <h3 id="statRefeicoes">0</h3>
                    <p>Refei√ß√µes Hoje</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon gold">‚≠ê</div>
                <div class="stat-info">
                    <h3 id="statPontos">0</h3>
                    <p>Pontos no Sistema</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon green">üë•</div>
                <div class="stat-info">
                    <h3 id="statProximos">0</h3>
                    <p>Clientes Pr√≥ximos (8-10 pts)</p>
                </div>
            </div>
        </div>

        <!-- Search -->
        <div class="search-card">
            <h2>Gest√£o de Pontos</h2>
            <div class="search-form">
                <input type="text" class="search-input" id="searchInput" placeholder="C√≥digo, nome ou telem√≥vel...">
                <button class="btn-search">Pesquisar</button>
            </div>
        </div>

        <!-- Result -->
        <div class="result-card" id="resultCard" style="display: none;">
            <!-- Ser√° preenchido via JS -->
        </div>

        <!-- Clientes Pr√≥ximos -->
        <div class="proximos-card">
            <h3>Clientes Pr√≥ximos do Resgate</h3>
            <div id="listaClientesProximos">
                <!-- Ser√° preenchido via JS -->
            </div>
        </div>
    </div>

    <!-- Modal Adicionar Ponto -->
    <div class="modal" id="modalAdicionar">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Adicionar Ponto</h3>
            </div>
            <div class="modal-body">
                <!-- Ser√° preenchido via JS -->
            </div>
            <div class="modal-actions">
                <button class="btn btn-cancel">Cancelar</button>
                <button class="btn btn-confirm">‚úì Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal Sucesso -->
    <div class="modal" id="modalSucesso">
        <div class="modal-content">
            <div class="success-icon-modal">‚úì</div>
            <div class="modal-header">
                <h3>Ponto Adicionado!</h3>
            </div>
            <div class="modal-body">
                <!-- Ser√° preenchido via JS -->
            </div>
            <button class="btn btn-confirm" style="width: 100%;">OK</button>
        </div>
    </div>

    <script>
        window.addEventListener('load', async () => {
            try {
                // Verificar se √© staff
                const user = await verificarSessao();
                
                if (!user) {
                    alert('Precisa de fazer login primeiro!');
                    window.location.href = 'login.html';
                    return;
                }

                // Verificar se tem acesso ao backoffice
                const { data: staff, error } = await supabase
                    .from('backoffice_users')
                    .select('*')
                    .eq('id', user.id)
                    .single();

                if (error || !staff || !staff.ativo) {
                    alert('Acesso n√£o autorizado');
                    window.location.href = 'index.html';
                    return;
                }

                // Atualizar nome do staff
                if (staff.nome) {
                    document.getElementById('nomeStaff').textContent = `Ol√°, ${staff.nome}`;
                    document.querySelector('.user-avatar').textContent = staff.nome.charAt(0).toUpperCase();
                }

                // Carregar dados iniciais
                await carregarEstatisticas();
                await carregarClientesProximos();

            } catch (error) {
                alert('Erro ao carregar p√°gina. Por favor, tente novamente.');
            }
        });

        // Bot√£o de pesquisa
        document.addEventListener('DOMContentLoaded', () => {
            const btnSearch = document.querySelector('.btn-search');
            const searchInput = document.getElementById('searchInput');
            
            if (btnSearch) {
                btnSearch.addEventListener('click', () => {
                    const termo = searchInput.value.trim();
                    if (termo) {
                        executarPesquisa(termo);
                    } else {
                        alert('Por favor, introduza um termo de pesquisa');
                    }
                });
            }

            // Enter na pesquisa
            if (searchInput) {
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        const termo = searchInput.value.trim();
                        if (termo) {
                            executarPesquisa(termo);
                        }
                    }
                });
            }

            // Fechar modais ao clicar no fundo
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('show');
                    }
                });
            });

            // Bot√£o cancelar no modal
            const btnCancel = document.querySelector('#modalAdicionar .btn-cancel');
            if (btnCancel) {
                btnCancel.addEventListener('click', () => {
                    document.getElementById('modalAdicionar').classList.remove('show');
                });
            }

            // Bot√£o OK no modal sucesso
            const btnOk = document.querySelector('#modalSucesso .btn-confirm');
            if (btnOk) {
                btnOk.addEventListener('click', () => {
                    fecharModalSucesso();
                });
            }
        });
    </script>
    <div data-include="components/scripts.html"></div>
</body>
</html>