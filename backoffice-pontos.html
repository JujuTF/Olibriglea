<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backoffice - Gest√£o de Pontos</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Lora:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/responsive.css">
</head>
<body>
    <!-- Header -->
    <header>
        <nav>
            <a href="index.html" class="logo-header">
                <div class="logo-small">
                    <img src="images/logo.jpg" alt="Olibriglea">
                </div>
                <span class="logo-text">Olibriglea - Backoffice</span>
            </a>
            <ul class="nav-menu">
                <li><a href="#" id="nomeStaff">Staff</a></li>
                <li><a href="#" id="btnLogout" class="btn-logout-header">Sair</a></li>
            </ul>
        </nav>
    </header>

    <div class="container">
        <!-- Loading inicial -->
        <div id="loading" style="text-align: center; padding: 4rem;">
            <h2>‚è≥ Carregando backoffice...</h2>
            <p id="loadingStatus">Inicializando...</p>
        </div>

        <!-- Conte√∫do (escondido at√© verificar) -->
        <div id="content" style="display: none;">
            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üçΩÔ∏è</div>
                    <h3 id="statRefeicoes">0</h3>
                    <p>Refei√ß√µes Hoje</p>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚≠ê</div>
                    <h3 id="statPontos">0</h3>
                    <p>Pontos no Sistema</p>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üë•</div>
                    <h3 id="statProximos">0</h3>
                    <p>Clientes Pr√≥ximos (8-10 pts)</p>
                </div>
            </div>

            <!-- Search -->
            <div class="main-content">
                <h2>Gest√£o de Pontos</h2>
                <div class="search-form">
                    <input type="text" class="search-input" id="searchInput" placeholder="C√≥digo, nome ou telem√≥vel...">
                    <button class="btn-search" onclick="pesquisar()">Pesquisar</button>
                </div>

                <!-- Result -->
                <div id="resultCard" style="display: none; margin-top: 2rem;">
                    <!-- Ser√° preenchido via JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // ============================================
        // AGUARDAR SUPABASE CARREGAR
        // ============================================
        async function aguardarSupabase() {
            let tentativas = 0;
            
            while (typeof supabase === 'undefined' && tentativas < 50) {
                await new Promise(r => setTimeout(r, 100));
                tentativas++;
            }
            
            if (typeof supabase === 'undefined') {
                console.error('‚ùå Supabase n√£o carregou!');
                return false;
            }
            
            return true;
        }
        
        // ============================================
        // ATUALIZAR STATUS DE LOADING
        // ============================================
        function atualizarStatus(mensagem) {
            const status = document.getElementById('loadingStatus');
            if (status) {
                status.textContent = mensagem;
            }
           }
        
        // ============================================
        // VERIFICAR ACESSO
        // ============================================
        async function verificarAcesso() {
            try {
                atualizarStatus('Verificando login...');
                
                // 1. Aguardar Supabase
                const supabaseOK = await aguardarSupabase();
                if (!supabaseOK) {
                    throw new Error('Supabase n√£o carregou. Por favor, recarregue a p√°gina.');
                }
                
                // 2. Carregar config
                atualizarStatus('Carregando configura√ß√£o...');
                await new Promise(r => setTimeout(r, 500)); // Dar tempo para config.js carregar
                
                // 3. Verificar se est√° logado
                atualizarStatus('Verificando sess√£o...');
                const { data: { user }, error: authError } = await supabase.auth.getUser();
                
                if (authError || !user) {
                    throw new Error('N√£o est√° logado. Redirecionando para login...');
                }
                
                
                // 4. Verificar se √© STAFF
                atualizarStatus('Verificando permiss√µes...');
                
                const { data: staffData, error: staffError } = await supabase
                    .from('backoffice_users')
                    .select('*')
                    .eq('id', user.id)
                    .maybeSingle();
                
                if (staffError) {
                    console.error('‚ùå Erro ao verificar staff:', staffError);
                }
                
                if (!staffData) {
                    throw new Error('Acesso n√£o autorizado! Esta √°rea √© apenas para staff.');
                }
                
                // 5. Verificar se est√° ATIVO
                if (!staffData.ativo) {
                    throw new Error('Conta desativada. Contacte o administrador.');
                }
                
                
                // 6. Atualizar UI
                document.getElementById('nomeStaff').textContent = `Ol√°, ${staffData.nome}`;
                
                // 7. Mostrar conte√∫do
                atualizarStatus('Carregando dados...');
                await new Promise(r => setTimeout(r, 300));
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
                
                
            } catch (error) {
                console.error('‚ùå Erro:', error);
                alert(error.message);
                
                // Fazer logout se houver
                try {
                    await supabase.auth.signOut();
                } catch (e) {
                    
                }
                
                // Redirecionar
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 1000);
            }
        }
        
        // ============================================
        // LOGOUT
        // ============================================
        async function fazerLogout(e) {
            if (e) e.preventDefault();
            
            if (!confirm('Tem a certeza que quer sair?')) {
                return;
            }
            
            try {
                await supabase.auth.signOut();
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Erro no logout:', error);
                alert('Erro ao sair. Tente novamente.');
            }
        }
        
        // ============================================
        // FUN√á√ïES PLACEHOLDER
        // ============================================
        function pesquisar() {
            const termo = document.getElementById('searchInput').value;
            alert('Fun√ß√£o de pesquisa em desenvolvimento!\n\nPesquisar: ' + termo);
        }
        
        // ============================================
        // INICIALIZAR
        // ============================================
        window.addEventListener('load', async () => {
            await verificarAcesso();
            
            // Adicionar event listener ao logout
            const btnLogout = document.getElementById('btnLogout');
            if (btnLogout) {
                btnLogout.addEventListener('click', fazerLogout);
            }
        });
        
        // Executar tamb√©m imediatamente (fallback)
        setTimeout(() => {
            if (document.getElementById('content').style.display === 'none') {
                verificarAcesso();
            }
        }, 2000);
    </script>
    
    <!-- Carregar config.js DEPOIS do script acima -->
    <script src="js/config.js"></script>
</body>
</html>