<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backoffice - Gest√£o de Pontos</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Lora:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/responsive.css">
    <link rel="stylesheet" href="css/backoffice.css">
</head>
<body>
    <div data-include="components/header.html"></div>

    <div class="container">
        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon blue">üçΩÔ∏è</div>
                <div class="stat-info">
                    <h3 id="statRefeicoes">0</h3>
                    <p class="stat-label">Refei√ß√µes Hoje</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon gold">‚≠ê</div>
                <div class="stat-info">
                    <h3 id="statPontos">0</h3>
                    <p class="stat-label">Pontos no Sistema</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon green">üë•</div>
                <div class="stat-info">
                    <h3 id="statProximos">0</h3>
                    <p class="stat-label">Clientes Pr√≥ximos (8-10 pts)</p>
                </div>
            </div>
        </div>

        <!-- Search -->
        <div class="search-card">
            <h2>Gest√£o de Pontos</h2>
            <div class="search-form">
                <input type="text" class="search-input" id="searchInput" placeholder="C√≥digo, nome ou telem√≥vel...">
                <button class="btn-search">Pesquisar</button>
            </div>
        </div>

        <!-- Result -->
        <div class="result-card" id="resultCard" style="display: none;">
            <!-- Ser√° preenchido via JS -->
        </div>

        <!-- Clientes Pr√≥ximos -->
        <div class="proximos-card">
            <h3>Clientes Pr√≥ximos do Resgate</h3>
            <div id="listaClientesProximos">
                <p style="text-align: center; color: #999; padding: 2rem;">Carregando...</p>
            </div>
        </div>
    </div>

    <!-- Modal Adicionar Ponto -->
    <div class="modal" id="modalAdicionar">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Adicionar Ponto</h3>
            </div>
            <div class="modal-body">
                <!-- Ser√° preenchido via JS -->
            </div>
            <div class="modal-actions">
                <button class="btn btn-cancel">Cancelar</button>
                <button class="btn btn-confirm">‚úì Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal Sucesso -->
    <div class="modal" id="modalSucesso">
        <div class="modal-content">
            <div class="success-icon-modal">‚úì</div>
            <div class="modal-header">
                <h3>Ponto Adicionado!</h3>
            </div>
            <div class="modal-body">
                <!-- Ser√° preenchido via JS -->
            </div>
            <button class="btn btn-confirm" style="width: 100%;" onclick="fecharModalSucesso()">OK</button>
        </div>
    </div>

    <!-- Scripts - ORDEM CORRETA -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/includes.js"></script>
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/session.js"></script>
    <script src="js/pontos.js"></script>

    <script>
        console.log('=== BACKOFFICE: Inicializando ===');

        // Aguardar todos os scripts carregarem
        async function carregarScriptsBackoffice() {
            // Pequeno delay para garantir que tudo carregou
            await new Promise(resolve => setTimeout(resolve, 500));

            // Verificar se as fun√ß√µes existem
            if (typeof carregarEstatisticas === 'undefined') {
                console.error('‚ùå carregarEstatisticas n√£o est√° definida!');
                console.error('Certifique-se que js/pontos.js est√° carregado');
                alert('Erro ao carregar backoffice: carregarEstatisticas is not defined');
                return;
            }

            if (typeof carregarClientesProximos === 'undefined') {
                console.error('‚ùå carregarClientesProximos n√£o est√° definida!');
                return;
            }

            console.log('‚úÖ Fun√ß√µes carregadas com sucesso');
            await inicializarBackoffice();
        }

        async function inicializarBackoffice() {
            try {
                console.log('üîê Verificando autentica√ß√£o...');
                
                // Verificar se √© staff
                const user = await verificarSessao();
                
                if (!user) {
                    alert('Precisa de fazer login primeiro!');
                    window.location.href = 'login.html';
                    return;
                }

                console.log('üë§ Utilizador autenticado:', user.email);

                // Verificar se tem acesso ao backoffice
                const { data: staff, error } = await supabase
                    .from('backoffice_users')
                    .select('*')
                    .eq('id', user.id)
                    .single();

                if (error || !staff || !staff.ativo) {
                    console.error('‚ùå Acesso negado:', error);
                    alert('Acesso n√£o autorizado');
                    window.location.href = 'index.html';
                    return;
                }

                console.log('‚úÖ Acesso autorizado:', staff.nome);

                // Carregar dados iniciais
                console.log('üìä Carregando estat√≠sticas...');
                await carregarEstatisticas();

                console.log('üë• Carregando clientes pr√≥ximos...');
                await carregarClientesProximos();

                console.log('‚úÖ Backoffice inicializado com sucesso!');

            } catch (error) {
                console.error('‚ùå Erro ao carregar backoffice:', error);
                alert('Erro ao carregar p√°gina. Por favor, tente novamente.');
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üìÑ DOM carregado');

            // Bot√£o de pesquisa
            const btnSearch = document.querySelector('.btn-search');
            const searchInput = document.getElementById('searchInput');
            
            if (btnSearch) {
                btnSearch.addEventListener('click', () => {
                    const termo = searchInput.value.trim();
                    if (termo) {
                        executarPesquisa(termo);
                    } else {
                        alert('Por favor, introduza um termo de pesquisa');
                    }
                });
            }

            // Enter na pesquisa
            if (searchInput) {
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        const termo = searchInput.value.trim();
                        if (termo) {
                            executarPesquisa(termo);
                        }
                    }
                });
            }

            // Fechar modais ao clicar no fundo
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('show');
                    }
                });
            });

            // Bot√£o cancelar no modal
            const btnCancel = document.querySelector('#modalAdicionar .btn-cancel');
            if (btnCancel) {
                btnCancel.addEventListener('click', () => {
                    document.getElementById('modalAdicionar').classList.remove('show');
                });
            }
        });

        // Iniciar quando a p√°gina carregar completamente
        window.addEventListener('load', () => {
            console.log('üöÄ P√°gina carregada completamente');
            carregarScriptsBackoffice();
        });

        // Fallback: tentar tamb√©m ap√≥s includes carregarem
        document.addEventListener('includesCarregados', () => {
            console.log('üì¶ Includes carregados');
            // S√≥ iniciar se ainda n√£o iniciou
            if (typeof carregarEstatisticas !== 'undefined' && 
                document.getElementById('statRefeicoes').textContent === '0') {
                carregarScriptsBackoffice();
            }
        });
    </script>
</body>
</html>