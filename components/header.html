<!-- Header Comum - Todas as P√°ginas -->
<header>
    <nav>
        <a href="index.html" class="logo-header">
            <div class="logo-small">
                <img src="images/logo.jpg" alt="Olibriglea">
            </div>
            <span class="logo-text">Olibriglea</span>
        </a>
        <button class="nav-toggle" aria-label="Abrir menu" onclick="displayMenu()" id="nav-toggle">
                <img src="/images/menu.png"> 
            </button>
        <ul class="nav-menu" id="nav-menu">
            <li><a href="index.html#ementa">Ementa</a></li>
            <li><a href="index.html#sobre">Sobre</a></li>
            <li><a href="index.html#contactos">Contactos</a></li>
            <li>
                <a href="login.html" class="btn-login-header" id="btnLoginHeader">√Årea de cliente</a>
            </li>
            <li style="display: none;" id="liLogout">
                <a href="#" id="btnLogout" >Sair</a>
            </li>
        </ul>
    </nav>
</header>

<script>
function displayMenu(){
        document.getElementById('nav-menu').style.display = 'block';
        document.getElementById('nav-toggle').setAttribute( "onClick", "hideMenu()");

    }

    function hideMenu(){
        document.getElementById('nav-menu').style.display = 'none';
        document.getElementById('nav-toggle').setAttribute( "onClick", "displayMenu()");

    }

// Header inteligente - reconhece clientes E staff
(function() {
    'use strict';
    
    function atualizarHeader() {
        // Verificar se supabase existe
        if (typeof window.supabase === 'undefined' || !window.supabase) {
            setTimeout(atualizarHeader, 500);
            return;
        }
        
        if (typeof window.supabase.auth === 'undefined' || !window.supabase.auth.getUser) {
            setTimeout(atualizarHeader, 500);
            return;
        }
        
        // Buscar sess√£o
        window.supabase.auth.getUser()
            .then(async ({ data: { user }, error }) => {
                const btnLogin = document.getElementById('btnLoginHeader');
                const liLogout = document.getElementById('liLogout');
                const btnLogout = document.getElementById('btnLogout');
                
                if (error || !user) {
                    // Sem sess√£o - mostrar bot√£o de login
                    if (btnLogin) {
                        btnLogin.textContent = '√Årea de cliente';
                        btnLogin.href = 'login.html';
                        btnLogin.parentElement.style.display = 'list-item';
                    }
                    if (liLogout) {
                        liLogout.style.display = 'none';
                    }
                    return;
                }
                
                // Tem sess√£o - verificar se √© staff OU cliente
                
                // 1. Tentar backoffice_users primeiro
                const { data: staffData, error: staffError } = await window.supabase
                    .from('backoffice_users')
                    .select('nome, ativo')
                    .eq('id', user.id)
                    .single();
                
                if (!staffError && staffData && staffData.ativo) {
                    // √â STAFF!
                    
                    if (btnLogin) {
                        btnLogin.textContent = `üë§ ${staffData.nome}`;
                        btnLogin.href = 'backoffice-pontos.html';
                    }
                    
                    if (liLogout) {
                        liLogout.style.display = 'list-item';
                    }
                    
                    configurarLogout(btnLogout);
                    return;
                }
                
                // 2. Se n√£o √© staff, tentar users (cliente)
                const { data: clienteData, error: clienteError } = await window.supabase
                    .from('users')
                    .select('nome')
                    .eq('id', user.id)
                    .single();
                
                if (!clienteError && clienteData) {
                    // √â CLIENTE!
                    
                    if (btnLogin) {
                        btnLogin.textContent = `Ol√°, ${clienteData.nome}`;
                        btnLogin.href = 'area-cliente.html';
                    }
                    
                    if (liLogout) {
                        liLogout.style.display = 'list-item';
                    }
                    
                    configurarLogout(btnLogout);
                    return;
                }
                
                // Se n√£o encontrou em nenhuma tabela
                if (btnLogin) {
                    btnLogin.textContent = 'Minha Conta';
                    btnLogin.href = 'area-cliente.html';
                }
                
                if (liLogout) {
                    liLogout.style.display = 'list-item';
                }
                
                configurarLogout(btnLogout);
            })
            .catch(err => {
            });
    }
    
    function configurarLogout(btnLogout) {
        if (!btnLogout) return;
        
        // S√≥ configurar uma vez
        if (btnLogout.hasAttribute('data-configured')) return;
        
        btnLogout.setAttribute('data-configured', 'true');
        btnLogout.addEventListener('click', async (e) => {
            e.preventDefault();
            
            if (confirm('Tem a certeza que quer sair?')) {
                try {
                    await window.supabase.auth.signOut();
                    window.location.href = 'index.html';
                } catch (error) {
                    console.error('‚ùå Erro no logout:', error);
                    alert('Erro ao sair. Tente novamente.');
                }
            }
        });
    }

    
    
    // Tentar atualizar v√°rias vezes
    setTimeout(atualizarHeader, 1000);
    setTimeout(atualizarHeader, 2000);
    setTimeout(atualizarHeader, 3000);
    
})();
</script>