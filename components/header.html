<!-- Header Comum - Todas as Páginas -->
<header>
    <nav>
        <a href="index.html" class="logo-header">
            <div class="logo-small">
                <img src="images/logo.jpg" alt="Olibriglea">
            </div>
            <span class="logo-text">Olibriglea</span>
        </a>
        <ul class="nav-menu">
            <li><a href="index.html#ementa">Ementa</a></li>
            <li><a href="index.html#sobre">Sobre</a></li>
            <li><a href="index.html#contactos">Contactos</a></li>
            
            <!-- Botões de autenticação (mudam conforme estado) -->
            <li id="navAuthButtons">
                <!-- Será preenchido dinamicamente -->
                <a href="login.html" class="btn-login-header">Iniciar Sessão</a>
            </li>
        </ul>
    </nav>
</header>

<script>

// ============================================
// INICIALIZAR HEADER
// ============================================
(function() {
    
    const navAuthButtons = document.getElementById('navAuthButtons');
    
    if (!navAuthButtons) {
        console.error('❌ Container de botões não encontrado!');
        return;
    }
    
    // ============================================
    // ATUALIZAR BOTÕES DO HEADER
    // ============================================
    async function atualizarBotoesHeader() {
        
        // Aguardar Supabase estar disponível
        let tentativas = 0;
        while (typeof supabase === 'undefined' && tentativas < 30) {
            await new Promise(r => setTimeout(r, 100));
            tentativas++;
        }
        
        if (typeof supabase === 'undefined') {
            console.warn('⚠️ Supabase não disponível após 3s');
            return;
        }
        
        try {
            const { data: { user } } = await supabase.auth.getUser();
            
            if (user) {
                
                // Buscar nome do utilizador
                let nomeUtilizador = 'Conta';
                try {
                    const { data: userData } = await supabase
                        .from('users')
                        .select('nome')
                        .eq('id', user.id)
                        .single();
                    
                    if (userData && userData.nome) {
                        nomeUtilizador = userData.nome;
                    }
                } catch (error) {
                }
                
                // LOGADO: Mostrar "A Minha Conta" + "Sair"
                navAuthButtons.innerHTML = `
                    <a href="area-cliente.html" class="btn-login-header">
                        Olá, ${nomeUtilizador}
                    </a>
                    <a href="#" id="btnLogout" class="btn-logout-header" style="margin-left: 1rem;">
                        Sair
                    </a>
                `;
                
                // Adicionar event listener ao botão de logout
                const btnLogout = document.getElementById('btnLogout');
                if (btnLogout) {
                    btnLogout.addEventListener('click', handleLogout);
                }
                
            } else {
                
                // NÃO LOGADO: Mostrar "Iniciar Sessão"
                navAuthButtons.innerHTML = `
                    <a href="login.html" class="btn-login-header">
                        Iniciar Sessão
                    </a>
                `;
            }
        } catch (error) {
            console.error('❌ Erro ao verificar sessão:', error);
        }
    }
    
    // ============================================
    // HANDLER DO LOGOUT
    // ============================================
    async function handleLogout(e) {
        e.preventDefault();
        
        if (!confirm('Tem a certeza que quer sair?')) {
            return;
        }
        
        try {
            const { error } = await supabase.auth.signOut();
            
            if (error) throw error;
            
            // Redirecionar para homepage
            window.location.href = 'index.html';
            
        } catch (error) {
            console.error('❌ Erro ao fazer logout:', error);
            alert('Erro ao sair. Tente novamente.');
        }
    }
    
    // ============================================
    // EXECUTAR ATUALIZAÇÃO
    // ============================================
    atualizarBotoesHeader();
    
    // Retry após 1s e 3s
    setTimeout(atualizarBotoesHeader, 1000);
    setTimeout(atualizarBotoesHeader, 3000);
    
    // Subscrever a mudanças de autenticação
    setTimeout(() => {
        if (typeof supabase !== 'undefined' && supabase.auth) {
            supabase.auth.onAuthStateChange((event, session) => {
                atualizarBotoesHeader();
            });
        }
    }, 2000);
    
})();
</script>